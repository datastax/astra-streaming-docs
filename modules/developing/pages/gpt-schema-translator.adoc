= GPT Schema Translator

[NOTE]
====
The GPT Schema Translator is currently only available for the xref:streaming-learning:pulsar-io:connectors/sinks/astra-db.adoc[Astra DB Sink Connector].
====

== Overview

Systems within streaming pipelines typically represent schema and data types differently. This requires schemas within a pipeline to be mapped to each other, a process which is complicated, tedious, and error-prone. For example, to send data from a CDC-enabled C* table to a Pulsar topic, you must define a schema mapping between the C* table and the Pulsar topic, represented below.
[tabs]
====
CQL table schema::
+
--
[source,cql]
----
CREATE TABLE users (
  user_id UUID PRIMARY KEY,
  first_name TEXT,
  last_name TEXT,
  email TEXT,
  age INT
);
----
--

AVRO schema::
+
--
[source,avro]
----
{
  "type": "record",
  "name": "User",
  "namespace": "com.example",
  "fields": [
    {
      "name": "user_id",
      "type": "string",
      "logicalType": "uuid"
    },
    {
      "name": "first_name",
      "type": "string"
    },
    {
      "name": "last_name",
      "type": "string"
    },
    {
      "name": "email",
      "type": "string"
    },
    {
      "name": "age",
      "type": "int"
    }
  ]
}
----
--
====

Now, imagine you want to sink this data onward to Elasticsearch, or to a Kafka topic. You must define a new schema mapping for each of these destinations! This kind of work is difficult for humans to deal with because it requires understanding rules across various domains and translating between them, but it is trivial work for the GPT-4 AI model.

The GPT-based schema translator uses generative AI to automatically generate schema mappings from Astra Streaming (Pulsar topics) to the Astra DB sink connector (CQL tables).
In Astra Streaming, schemas are associated with a Pulsar topic, and represented in either JSON or Avro.
Astra DB represents schemas in CQL.

The GPT-based schema translator will suggest a mapping from the schema in the Pulsar topic to the schema in the Astra DB table, using the domain-specific language (DSL) specified by the Astra DB Sink Connector.

== Usage

To use the GPT-based schema translator, create an AstraDB sink connector as you usually would. If you're unsure about this, see the xref:streaming-learning:pulsar-io:connectors/sinks/astra-db.adoc[Astra DB Sink Connector documentation]. Then, use the GPT-based schema translator to generate a schema mapping for the connector.

image::two-schemas.png[Schemas,320,240,align="center"]

In this example, we have two schemas: one for the Pulsar topic, and one for the Astra DB table. The GPT-based schema translator will generate a mapping between the two schemas, which can be used by the Astra DB sink connector to write data from the Pulsar topic to the Astra DB table.

image::create-schema-mapping.png[Schema mapping,320,240]

To generate a schema mapping, click the "Generate Schema Mapping" button. This will open a model with the schema mapping generated by the GPT-based schema translator.

Here are few examples to get started:

* <<pulsar-topic-to-cql-table,>>
* <<cql-table-to-avro,>>
* <<no-schema,>>

[#pulsar-topic-to-cql-table]
== Pulsar topic to CQL table
This example will produce a mapping between a Pulsar Topic Schema and a Cassandra Table Schema.
When schemas are available to the GPT-based schema translator, the button prompt will change to notify you to generate a mapping between the two schemas.
+
[tabs]
====
Pulsar Topic Schema::
+
--
[source,]
----
 "pulsar_topic_schemas": {
        "person": {
            "type": "record",
            "name": "Person",
            "namespace": "org.apache.pulsar.io.datagenerator",
            "fields": [
              {
                "name": "address",
                "type": [
                  "null",
                  {
                    "type": "record",
                    "name": "Address",
                    "namespace": "org.apache.pulsar.io.datagenerator.Person",
                    "fields": [
                      {
                        "name": "apartmentNumber",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "city",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "postalCode",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "street",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "streetNumber",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      }
                    ]
                  }
                ],
                "default": null
              },
              {
                "name": "age",
                "type": [
                  "null",
                  "int"
                ],
                "default": null
              },
              {
                "name": "company",
                "type": [
                  "null",
                  {
                    "type": "record",
                    "name": "Company",
                    "namespace": "org.apache.pulsar.io.datagenerator.Person",
                    "fields": [
                      {
                        "name": "domain",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "email",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "name",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "vatIdentificationNumber",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      }
                    ]
                  }
                ],
                "default": null
              },
              {
                "name": "companyEmail",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "dateOfBirth",
                "type": {
                  "type": "long",
                  "logicalType": "timestamp-millis"
                }
              },
              {
                "name": "email",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "firstName",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "lastName",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "middleName",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "nationalIdentificationNumber",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "nationalIdentityCardNumber",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "passportNumber",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "password",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "sex",
                "type": [
                  "null",
                  {
                    "type": "enum",
                    "name": "Sex",
                    "namespace": "org.apache.pulsar.io.datagenerator.Person",
                    "symbols": [
                      "MALE",
                      "FEMALE"
                    ]
                  }
                ],
                "default": null
              },
              {
                "name": "telephoneNumber",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "username",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              }
            ]
          },
----
--

CQL Schema::
+
--
[source,]
----
"cassandra_table_schemas": {
        "person": {
            "primaryKey": {
              "partitionKey": [
                "passportnumber"
              ]
            },
            "columnDefinitions": [
              {
                "name": "passportnumber",
                "typeDefinition": "text",
                "static": false
              },
              {
                "name": "age",
                "typeDefinition": "varint",
                "static": false
              },
              {
                "name": "firstname",
                "typeDefinition": "text",
                "static": false
              },
              {
                "name": "lastname",
                "typeDefinition": "text",
                "static": false
              }
            ]
          },
----
--

Result::
+
--
[source,bash]
----
passportnumber=value.passportNumber, age=value.age, firstname=value.firstName, lastname=value.lastName
----
--
====

[#cql-table-to-avro]
== CQL table to AVRO
Given a Cassandra table schema, this example will output an AVRO or JSON schema and mapping.
Build the payload for the request:
[tabs]
====
CQL::
+
--
[source,cql]
----
payload = {
    "context": "",
    "table_schema": example_schemas["cassandra_table_schemas"]["click_stream"],
    "output_type": "JSON"
}
----
--

Result::
+
--
[source,json]
----
result
----
--
====

== No schema
Even with no schema declared, the GPT-based schema translator can still provide a schema mapping that mirrors the values of your table schema. +
For example, starting with this schema on a CQL table:
[tabs]
====
CQL Table::
+
--
[source,cql]
----
{
  "primaryKey": {
    "partitionKey": [
      "passportnumber"
    ]
  },
  "columnDefinitions": [
    {
      "name": "passportnumber",
      "typeDefinition": "text",
      "static": false
    },
    {
      "name": "age",
      "typeDefinition": "varint",
      "static": false
    },
    {
      "name": "firstname",
      "typeDefinition": "text",
      "static": false
    },
    {
      "name": "lastname",
      "typeDefinition": "text",
      "static": false
    }
  ]
}
----
--

Result::
+
--
[source,bash]
----
passportnumber=value.passportnumber, age=value.age, firstname=value.firstname, lastname=value.lastname
----
--
====

// this is the schema from the cql table
[source,cql]
----
{
  "primaryKey": {
    "partitionKey": [
      "passportnumber"
    ]
  },
  "columnDefinitions": [
    {
      "name": "passportnumber",
      "typeDefinition": "text",
      "static": false
    },
    {
      "name": "age",
      "typeDefinition": "varint",
      "static": false
    },
    {
      "name": "firstname",
      "typeDefinition": "text",
      "static": false
    },
    {
      "name": "lastname",
      "typeDefinition": "text",
      "static": false
    }
  ]
}
----
== What's next?


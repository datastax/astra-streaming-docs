= GPT Schema Translator

[NOTE]
====
The GPT Schema Translator is currently only available for the Astra DB Sink Connector.
====

== Overview

Systems within streaming pipelines typically use different approaches for schema representations and data type definitions. This requires schemas within a pipeline to be mapped to each other, a process which is complicated, tedious, and error-prone.

The GPT-based schema translator uses generative AI to automatically generate schema mappings from Astra Streaming (Pulsar topics) to the Astra DB sink connector (CQL tables).
In Astra Streaming, schemas are associated with a Pulsar topic, and represented in either JSON or Avro.
Astra DB represents schemas in CQL.

The GPT-based schema translator will suggest a mapping from the schema in the Pulsar topic to the schema in the Astra DB table, using the domain-specific language (DSL) specified by the Astra DB Sink Connector.

== Usage

To use the GPT-based schema translator, create an AstraDB sink connector as you usually would. (If you're unsure about this, see the xref:streaming-learning-docs:pulsar-io:sinks/astra-db.adoc[Astra DB Sink Connector documentation].) Then, use the GPT-based schema translator to generate a schema mapping for the connector.

Here are few examples to get started:

* <<pulsar-topic-to-cql-table,>>
* <<cql-table-to-avro,>>
* <<no-schema,>>

This example will provide a schema mapping for the Astra sink connector to get streaming data from Astra Streaming and write this data to an Astra DB table.

[#pulsar-topic-to-cql-table]
== Pulsar topic to CQL table
This example will produce a mapping between a Pulsar Topic Schema and a Cassandra Table Schema.
When schemas are available to the GPT-based schema translator, the button prompt will change to notify you to generate a mapping between the two schemas.
+
image::two-schemas.png[]
+
[tabs]
====
Pulsar Topic Schema::
+
--
[source,]
----
 "pulsar_topic_schemas": {
        "person": {
            "type": "record",
            "name": "Person",
            "namespace": "org.apache.pulsar.io.datagenerator",
            "fields": [
              {
                "name": "address",
                "type": [
                  "null",
                  {
                    "type": "record",
                    "name": "Address",
                    "namespace": "org.apache.pulsar.io.datagenerator.Person",
                    "fields": [
                      {
                        "name": "apartmentNumber",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "city",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "postalCode",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "street",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "streetNumber",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      }
                    ]
                  }
                ],
                "default": null
              },
              {
                "name": "age",
                "type": [
                  "null",
                  "int"
                ],
                "default": null
              },
              {
                "name": "company",
                "type": [
                  "null",
                  {
                    "type": "record",
                    "name": "Company",
                    "namespace": "org.apache.pulsar.io.datagenerator.Person",
                    "fields": [
                      {
                        "name": "domain",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "email",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "name",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      },
                      {
                        "name": "vatIdentificationNumber",
                        "type": [
                          "null",
                          "string"
                        ],
                        "default": null
                      }
                    ]
                  }
                ],
                "default": null
              },
              {
                "name": "companyEmail",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "dateOfBirth",
                "type": {
                  "type": "long",
                  "logicalType": "timestamp-millis"
                }
              },
              {
                "name": "email",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "firstName",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "lastName",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "middleName",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "nationalIdentificationNumber",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "nationalIdentityCardNumber",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "passportNumber",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "password",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "sex",
                "type": [
                  "null",
                  {
                    "type": "enum",
                    "name": "Sex",
                    "namespace": "org.apache.pulsar.io.datagenerator.Person",
                    "symbols": [
                      "MALE",
                      "FEMALE"
                    ]
                  }
                ],
                "default": null
              },
              {
                "name": "telephoneNumber",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              },
              {
                "name": "username",
                "type": [
                  "null",
                  "string"
                ],
                "default": null
              }
            ]
          },
----
--

CQL Schema::
+
--
[source,]
----
"cassandra_table_schemas": {
        "person": {
            "primaryKey": {
              "partitionKey": [
                "passportnumber"
              ]
            },
            "columnDefinitions": [
              {
                "name": "passportnumber",
                "typeDefinition": "text",
                "static": false
              },
              {
                "name": "age",
                "typeDefinition": "varint",
                "static": false
              },
              {
                "name": "firstname",
                "typeDefinition": "text",
                "static": false
              },
              {
                "name": "lastname",
                "typeDefinition": "text",
                "static": false
              }
            ]
          },
----
--

Result::
+
--
[source,bash]
----
passportnumber=value.passportNumber, age=value.age, firstname=value.firstName, lastname=value.lastName
----
--
====

[#cql-table-to-avro]
== CQL table to AVRO
Given a Cassandra table schema, this example will output an AVRO or JSON schema and mapping.
Build the payload for the request:
[tabs]
====
CQL::
+
--
[source,cql]
----
payload = {
    "context": "",
    "table_schema": example_schemas["cassandra_table_schemas"]["click_stream"],
    "output_type": "JSON"
}
----
--

Result::
+
--
[source,json]
----
result
----
--
====

== No schema
Even with no schema declared, the GPT-based schema translator can still provide a schema mapping that mirrors the values of your table schema. +
For example, starting with this schema on a CQL table:
[tabs]
====
CQL Table::
+
--
[source,cql]
----
{
  "primaryKey": {
    "partitionKey": [
      "passportnumber"
    ]
  },
  "columnDefinitions": [
    {
      "name": "passportnumber",
      "typeDefinition": "text",
      "static": false
    },
    {
      "name": "age",
      "typeDefinition": "varint",
      "static": false
    },
    {
      "name": "firstname",
      "typeDefinition": "text",
      "static": false
    },
    {
      "name": "lastname",
      "typeDefinition": "text",
      "static": false
    }
  ]
}
----
--

Result::
+
--
[source,bash]
----
passportnumber=value.passportnumber, age=value.age, firstname=value.firstname, lastname=value.lastname
----
--
====

// this is the schema from the cql table
[source,cql]
----
{
  "primaryKey": {
    "partitionKey": [
      "passportnumber"
    ]
  },
  "columnDefinitions": [
    {
      "name": "passportnumber",
      "typeDefinition": "text",
      "static": false
    },
    {
      "name": "age",
      "typeDefinition": "varint",
      "static": false
    },
    {
      "name": "firstname",
      "typeDefinition": "text",
      "static": false
    },
    {
      "name": "lastname",
      "typeDefinition": "text",
      "static": false
    }
  ]
}
----
== What's next?

